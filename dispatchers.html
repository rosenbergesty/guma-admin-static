<!Doctype>
<html>
  <head>
    <title>Guma</title>
    <link href="https://fonts.googleapis.com/css?family=Muli:300,400|Roboto" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.10.16/css/dataTables.bootstrap4.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet" >
    <link href="css/header.css" rel="stylesheet" >
    <link href="css/drivers.css" rel="stylesheet" >

  </head>
  <body>
    <div class="loader-screen"></div>
    <header class="nav-bar d-flex align-items-center sticky-top">
      <div class="nav-opener">
        <i class="material-icons">menu</i>
      </div>
      <div class="logo">
        <h1>Guma</h1>
      </div>
      <div class="user ml-auto">
        <div class="icon"></div>
      </div>
      <div class="logout-popup">
        <ul>
          <li><a href="#" class="nav-link" id="logout"><span class="material-icons">power_settings_new</span>Logout</a>
        </ul>
      </div>
    </header>
    <nav class="w-25 h-100 float-left">
      <ul class="nav flex-column">
        <li><a class="nav-link" href="dashboard.html"><span class="material-icons">dashboard</span><span class="text">Dashboard</span></a></li>
        <li><a class="nav-link" href="drivers.html"><span class="material-icons">local_shipping</span><span class="text">Drivers</span></a></li>
        <li><a class="nav-link active" href="dispatchers.html"><span class="material-icons">tap_and_play</span><span class="text">Dispatchers</span></a></li>
        <li><a class="nav-link" href="stops.html"><span class="material-icons">location_searching</span><span class="text">Stops</span></a></li>
        <li><a class="nav-link" href="reports.html"><span class="material-icons">insert_chart</span><span class="text">Reports</span></a></li>
      </ul>
    </nav>
    <div class="content w-75 p-3 float-right">
      <h2 class="title">Dispatchers</h2>
      <div class="main">
        <div class="actions">
          <a href="#" class="addDispatcher button">Add</a>
          <a href="#" class="importDispatcher button">Import</a>
          <a href="#" class="exportDispatcher button">Export</a>
        </div>
        <div class="table-wrapper">
          <table id="dispatchersTable" class="display" cellspacing="0" width="100%">
            <thead>
              <tr class="header-row">
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Stops</th>
              </tr>
            </thead>
            <tbody>

            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Popups -->
    <div class="modal" id="addDispatcherModal">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">Add Dispatcher</h3>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="addDispatcherForm" novalidate>
              <div class="form-group">
                <label for="addDispatcherName">Name</label>
                <input type="text" class="form-control" id="addDispatcherName" placeholder="Enter name" required>
                <div class="invalid-feedback">
                  Please enter a name
                </div>
              </div>
              <div class="form-group">
                <label for="addDispatcherEmail">Email Address</label>
                <input type="email" class="form-control" id="addDispatcherEmail" placeholder="Password" required>
                <div class="invalid-feedback">
                  Please enter a valid email address
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <a href="#" class="button addDispatcherSubmit">Add</a>
            <a href="#" class="button" data-dismiss="modal">Close</a>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="importModal">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">Import Dispatchers</h3>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="import-form" novalidate>
              <div class="fallback">
                <input type="file" name="upfile" id="upfile">
              </div>
              <span>Click or drag files to upload.</span>
            </form>
            <div class="import-success">
              <h2>Successfully imported spreadsheet.</h2>
            </div>
          </div>
          <div class="modal-footer">
            <a href="#" class="button importSubmit">Import</a>
            <a href="#" class="button" data-dismiss="modal">Close</a>
          </div>
        </div>
      </div>
    </div>
    <footer>

    </footer>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.16/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
    <script src="js/dropzone.js"></script>
    <script src="js/global.js"></script>
    <script>
      $(document).ready(function(){

          // Table
          var dispatchersTable = $('#dispatchersTable').DataTable({
            "dom": '<"toolbar"f>rt<"bottom"lp><"clear">',
              "language": {
                "paginate": {
                  "next": ">",
                  "previous": "<"
                }
              }, 
              "columnDefs": [
                {
                  "targets": [0],
                  "visible": false,
                  "searchable": false
                }
              ]
          });

          var openSearch = $('<a href="#" class="open-search"><span class="material-icons">search</span></a>');
          $("div.toolbar").append(openSearch);
          openSearch.click(function(e){
            e.preventDefault();
            $("div.toolbar").toggleClass('open');
            $("div.toolbar input.form-control").focus();
          });

          function fetchDispatchers(){
            $.ajax({
              url: "http://estyrosenberg.com/guma/backend/fetch-all-dispatchers.php"
            }).done(function(data){
              console.log(data);
              $.each(JSON.parse(data), function( index, value ){

                $.ajax({
                  url: "http://estyrosenberg.com/guma/backend/fetch-stops-by-dispatcherId.php",
                  method: "POST",
                  data: {dispatcherID: value.ID}
                }).done(function(stops){
                  console.log(stops);
                  var count = 0;
                  if(JSON.parse(stops) != '0 results'){
                    $.each(JSON.parse(stops), function( index, value ){
                      count ++;
                    });
                  }

                  var arr = [value.ID, value.name, value.email];
                  arr.push(count);
                  dispatchersTable.row.add(arr).draw();

                }).fail(function(data){
                  console.log(data)
                });

              })

            }).fail(function(data){
              console.log(data);
            })
          }
          fetchDispatchers();

          // Click on dispatcher
          $('#dispatchersTable tbody').on('click', 'tr', function () {
              var data = dispatchersTable.row( this ).data();
              window.location.href = 'dispatcher.html?dispatcher='+data[0];
          } );


          // Add Dispatcher
          $('.addDispatcher').click(function(e){
            e.preventDefault();
            console.log('add');

            $('#addDispatcherModal').modal();
          });

          $('.addDispatcherSubmit').click(function(e){
            var valid = true;

            var name = $('#addDispatcherName').val();
            if(name.length < 1){
              console.log('name');
              valid = false;
            }

            var email = $('#addDispatcherEmail').val();
            if(!validateEmail(email)){
              console.log('email');
              valid = false;
            }

            if(valid){
              submitDispatcher(name, email);
            }
          });

          function submitDispatcher(name, email){
            $.ajax({
              url: "http://estyrosenberg.com/guma/backend/add-dispatcher.php",
              method: "POST",
              data: {name: name, email: email}
            }).done(function(data){
              console.log(JSON.parse(data));
              var resp = JSON.parse(data);
              if(resp[0].code == '200'){
                $('#addDispatcherModal').modal('hide');
                $('#addDispatcherName').val('');
                $('#addDispatcherEmail').val('');

                dispatchersTable.clear();
                fetchDispatchers();
              }
            });
          }

          function validateEmail(email) {
            var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(email);
          }


          // Import
          $('.importDispatcher').click(function(e){
            e.preventDefault();

            $('#import-form').show();
            $('.import-success').hide();
            $('.importSubmit').show();
            $('#importModal').modal();
          });

          var myDropzone = new Dropzone('#import-form', {
            url: 'http://estyrosenberg.com/guma/backend/import-dispatchers.php',
            paramName: 'upfile',
            autoProcessQueue: false
          });

          $('.importSubmit').click(function(e){
            e.preventDefault();
            myDropzone.processQueue();
          })
          myDropzone.on("success", function(file, data){
            var response = JSON.parse(data);
            myDropzone.removeAllFiles();
            $('#import-form').hide();
            $('.importSubmit').hide();

            if(response.code == 200){
              $('.import-success').show();
              if(typeof response.data.existing != 'undefined'){
                $('.import-success').append('<h3>The following dispatchers were not added because a dispatcher with the same email already exists.</h3>');
                $.each(response.data.existing[1], function(index, value){
                  $('.import-success').append('<p class="name-list">'+ value[0] + ' - ' + value[1] +'</p>');
                });
              }
              if(typeof response.data.failed != 'undefined'){
                $('.import-success').append('<h3>The following dispatchers failed to upload.</h3>');
                $.each(response.data.failed[1], function(index, value){
                  $('.import-success').append('<p class="name-list">'+ value[0] + ' - ' + value[1] +'</p>');
                });
              }
              if(typeof response.data.failedEmails != 'undefined'){
                $('.import-success').append('<h3>The email failed for the following dispatchers.</h3>');
                $.each(response.data.failedEmails[1], function(index, value){
                  $('.import-success').append('<p class="name-list">'+ value[0] + ' - ' + value[1] +'</p>');
                });
              }
            }
          });
          myDropzone.on("error", function(file, errorMessage){
            console.log(errorMessage);
          });

          // Export Dispatchers
          $('.exportDispatcher').click(function(e){
            e.preventDefault();

            $.ajax({
              url: "http://estyrosenberg.com/guma/backend/export-dispatchers.php"
            }).done(function(data){
              console.log(data);
              var file = new Blob([data], {type: "text/csv;charset=utf-8"});
              var filename = 'guma-dispatchers.csv'

              if (window.navigator.msSaveOrOpenBlob) // IE10+
                  window.navigator.msSaveOrOpenBlob(file, filename);
              else { // Others
                  var a = document.createElement("a"),
                          url = URL.createObjectURL(file);
                  a.href = url;
                  a.download = filename;
                  document.body.appendChild(a);
                  a.click();
                  setTimeout(function() {
                      document.body.removeChild(a);
                      window.URL.revokeObjectURL(url);  
                  }, 0); 
              }

            });
          })
      });
    </script>
  </body>
</html>